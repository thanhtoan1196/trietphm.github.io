<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Ph√¢n t√≠ch slow query PostgreSQL v·ªõi pgBadger &middot; Triet Pham</title>
        <meta name="description" content="Ph√¢n t√≠ch slow query PostgreSQL v·ªõi pgBadger">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.21" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://trietphm.github.io/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-93009521-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Tea, Coffee &amp; Code" href="https://trietphm.github.io/">Tea, Coffee &amp; Code</a>
                            </h1>
                        
                        <a class="button-square" href="https://trietphm.github.io/index.xml"><i class="fa fa-rss"></i></a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/trietphm">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="Reading list" href="/page/reading-list/">Reading list</a>
    </li>

    <li class="site-nav-item">
        <a title="Friends" href="/page/friends/">Friends</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/page/about/">About</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Ph√¢n t√≠ch slow query PostgreSQL v·ªõi pgBadger</h1>
    
        <p class="post-description" itemprop="description">Ph√¢n t√≠ch slow query PostgreSQL v·ªõi pgBadger</p>
    
    <p class="post-date">
        <span>Published <time datetime="2017-06-10" itemprop="datePublished">Sat, Jun 10, 2017</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="http://github.com/trietphm" itemprop="url" rel="author">Triet Pham</a>
            </span>
        </span>
    </p>
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    

<p><img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/5dvag1s1vh_logo_pgbadger.png" alt="alt text" /></p>

<h1 id="slow-query-l√†-g√¨">Slow query l√† g√¨?</h1>

<p>Khi c√°c c√¢u query ch·∫≠m h∆°n m·ªôt th·ªùi gian nh·∫•t ƒë·ªãnh t√πy theo b·∫°n ƒë·ªãnh nghƒ©a, v√≠ d·ª• ch·∫≠m h∆°n 50ms, th√¨ c√°c c√¢u query ƒë√≥ ƒë∆∞·ª£c xem l√† slow query.<br />
V√† t√πy theo ·ª©ng d·ª•ng m√† s·∫Ω c√≥ ƒë·ªãnh nghƒ©a kh√°c nhau, m·ªôt v√†i v√≠ d·ª•:</p>

<ul>
<li>B·∫°n vi·∫øt m·ªôt API authentication cho c√°i app nho nh·ªè v√† b·∫°n hy v·ªçng n√≥ ch·∫°y c√†ng nhanh c√†ng t·ªët, t·ªëi ƒëa l√† 30ms/request =&gt; Query ph·∫£i &lt; 30ms.<br /></li>
<li>B·∫°n vi·∫øt m·ªôt ·ª©ng d·ª•ng li√™n quan ƒë·∫øn ti·ªÅn b·∫°c, thanh to√°n online. ƒê√≤i h·ªèi b·∫Øt bu·ªôc l√† ph·∫£i ch√≠nh x√°c v√† an to√†n, ch·∫≠m m·ªôt ch√∫t c≈©ng kh√¥ng sao =&gt; Query c√≥ th·ªÉ n·ªõi ra th√†nh &lt; 100 ms.<br />
<br /></li>
</ul>

<p>T√πy theo m·ª•c ƒë√≠ch m√† c√≥ ti√™u chu·∫©n th·ªùi gian kh√°c nhau</p>

<h1 id="slow-query-x·∫£y-ra-khi-n√†o">Slow query x·∫£y ra khi n√†o?</h1>

<p>C√≥ r·∫•t nhi·ªÅu tr∆∞·ªùng h·ª£p s·∫Ω x·∫£y ra slow query nh∆∞:<br />
- Query condition tr√™n column thi·∫øu index<br />
- Query b·ªã lock b·ªüi c√°c c√¢u query, transaction,&hellip;<br />
- C√¢u query kh√¥ng ƒë∆∞·ª£c optimize n√™n d·∫´n ƒë·∫øn query th·ª´a ho·∫∑c kh√¥ng t·ªëi ∆∞u, sequence scan thay v√¨ index scan,&hellip;<br />
- C·∫•u h√¨nh m√°y kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c nhu c·∫ßu query hi·ªán t·∫°i.<br />
- &hellip;</p>

<p>C√≥ kh√° nhi·ªÅu nguy√™n nh√¢n c√≥ th·ªÉ x·∫£y ra v√† ƒë·ªÉ c√≥ th·ªÉ gi·∫£i quy·∫øt th√¨ vi·ªác ƒë·∫ßu ti√™n l√† ph·∫£i bi·∫øt n√≥ c√≥ x·∫£y ra üòÑ</p>

<h1 id="log-slow-query">Log slow query</h1>

<p>Postgresql cho ph√©p b·∫°n log c√°c c√¢u query, statement,&hellip; v√† nhi·ªÅu th·ª© kh√°c ra.<br />
ƒê·ªÉ log ra th√¨ b·∫°n c√≥ th·ªÉ edit file <code>postgresql.config</code> v√† thay ƒë·ªïi theo nhu c·∫ßu, m√¨nh li·ªát k√™ m·ªôt v√†i th√¥ng s·ªë c∆° b·∫£n ph·ª•c v·ª• cho b√†i vi·∫øt, b·∫°n c√≥ th·ªÉ xem th√™m ·ªü ƒë√¢y<br />
<a href="https://www.postgresql.org/docs/current/static/runtime-config-logging.html">https://www.postgresql.org/docs/current/static/runtime-config-logging.html</a></p>

<ul>
<li><code>log_directory</code>: N∆°i l∆∞u log, m·∫∑c ƒë·ªãnh th∆∞·ªùng l√† <code>pg_log</code><br /></li>
<li><code>log_filename</code>: format name c·ªßa file log<br /></li>
<li><code>log_min_duration_statement</code>: N·∫øu l·ªõn h∆°n th·ªùi gian n√†y query s·∫Ω ƒë∆∞·ª£c cho l√† slow query (ƒë∆°n v·ªã milisecond)<br />
<br /></li>
</ul>

<p>Save l·∫°i v√† reload (ho·∫∑c restart) PostgreSQL. Khi c√≥ slow query PostgreSQL s·∫Ω gi√∫p b·∫°n n√©m v√†o log.</p>

<p><em><strong>Note nh·ªè:</strong></em> Khi b·∫°n restart PostgreSQL, c√°c connection c·ªßa client ƒë·ªÅu s·∫Ω b·ªã disconnect</p>

<pre><code>          (‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ‚îª‚îÅ‚îª
</code></pre>

<p>nh∆∞ng n·∫øu b·∫°n reload th√¨ kh√¥ng sao c·∫£, m·ªçi th·ª© v·∫´n b√¨nh th∆∞·ªùng</p>

<pre><code>          (Ôæâ‚óï„ÉÆ‚óï)Ôæâ*:ÔΩ•Ôæü‚úß
</code></pre>

<p><code>sudo service postgresql reload</code></p>

<p>Khi log ra b·∫°n s·∫Ω th·∫•y nhi·ªÅu th√¥ng tin d·∫°ng th·∫ø n√†y v√† fix d·ªÖ d√†ng h∆°n</p>

<pre><code>593821c2.21a2 2017-06-08 00:00:41 ICT LOG:  duration: 439.218 ms  execute &lt;unnamed&gt;: SELECT * FROM &quot;users&quot;  WHERE (username = $1) LIMIT 1
593821c2.21a2 2017-06-08 00:00:41 ICT DETAIL:  parameters: $1 = 'trietphm'
</code></pre>

<h1 id="pgbadger">pgBadger</h1>

<h2 id="v√¨-sao-l·∫°i-c·∫ßn-log-analyzer">V√¨ sao l·∫°i c·∫ßn log analyzer?</h2>

<p>Sau m·ªôt ng√†y ƒë·∫πp tr·ªùi b·∫°n m·ªü file log l√™n v√† ch·ª£t nh·∫≠n ra n√≥ n·∫∑ng c·∫£ GB v·ªõi h·∫±ng h√† sa s·ªë log query slow, v·ªõi c∆° man n√†o l√† c√°c c√¢u query d√†i lo·∫±ng ngo·∫±ng hay nh·ªØng c√¢u query ng·∫Øn ng·ªßn nh∆∞ <code>SELECT * FROM users WHERE id = $1</code> m√† b·∫°n ch·∫Øc ch·∫Øn kh√¥ng th·ªÉ n√†o ch·∫≠m m√† v·∫´n xu·∫•t hi·ªán trong ƒë√¢y? R·ªìi c√≥ nh·ªØng c√¢u query b·∫°n c≈©ng kh√¥ng bi·∫øt n√≥ ƒë·∫øn t·ª´ server n√†o hay h√†nh tinh n√†o? Kh√¥ng bi·∫øt c√¢u query n√†o ch·∫≠m nh·∫•t ƒë·ªÉ m√† optimize? Kh√¥ng bi·∫øt v√† kh√¥ng bi·∫øt.</p>

<p>M·ªôt ƒë·ªëng h·ªón ƒë·ªôn v√† g·∫ßn nh∆∞ v√¥ d·ª•ng!</p>

<h2 id="pgbadger-l√†-g√¨">pgBadger l√† g√¨?</h2>

<p>pgBadger l√† m·ªôt PostgreSQL log analyzer nh·ªè g·ªçn ƒë∆∞·ª£c vi·∫øt b·∫±ng Perl script gi√∫p b·∫°n ph√¢n t√≠ch v√† report t·ª´ PostgreSQL log file.<br />
S·∫Ω gi√∫p b·∫°n khai th√°c ƒë∆∞·ª£c file h·ªón ƒë·ªôn kia, ƒë·∫≠p ƒë√° ra v√†ng. Sau khi x·ª≠ l√Ω pgBadge s·∫Ω xu·∫•t ra cho b·∫°n m·ªôt file HTML (ho·∫∑c JSON) report v·ªÅ file log ƒë√≥.</p>

<h1 id="c√†i-ƒë·∫∑t">C√†i ƒë·∫∑t</h1>

<ul>
<li>T·∫£i <a href="https://github.com/dalibo/pgbadger/releases">pgBadger</a><br /></li>
<li>V√† make<br />
<br /></li>
</ul>

<pre><code class="language-bash">        tar xzf pgbadger-9.x.tar.gz
        cd pgbadger-9.x/
        perl Makefile.PL
        make &amp;&amp; sudo make install
</code></pre>

<ul>
<li>Trong qu√° tr√¨nh c√†i ƒë·∫∑t c√≥ th·ªÉ b·ªã l·ªói v√† b·∫°n c·∫ßn c√†i th√™m <code>perl-devel</code>. C√†i ƒë·∫∑t trong Centos qua rpm <code>sudo yum install perl-devel</code><br />
<br /></li>
</ul>

<h2 id="update-format-log-file">Update format log file</h2>

<p>ƒê·ªÉ pgBadger c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c t·ªët file log, b·∫°n c·∫ßn update l·∫°i m·ªôt ch√∫t trong config:</p>

<ul>
<li><code>log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '</code> log ra c√°c th√¥ng tin user, database name, application v√† client ip address<br /></li>
<li>Enable c√°c option log kh√°c ƒë·ªÉ l·∫•y ƒë∆∞·ª£c nhi·ªÅu th√¥ng tin h∆°n:<br />
<br /></li>
</ul>

<pre><code>        log_checkpoints = on
        log_connections = on
        log_disconnections = on
        log_lock_waits = on
        log_temp_files = 0
        log_autovacuum_min_duration = 0
        log_error_verbosity = default
</code></pre>

<ul>
<li>B·∫°n c√≥ th·ªÉ xem th√™m trong <a href="http://dalibo.github.io/pgbadger/">Document </a><br />
<br /></li>
</ul>

<h2 id="parse-log-export-report">Parse log &amp; export report</h2>

<p>C√°ch ƒë∆°n gi·∫£n nh·∫•t:</p>

<pre><code>pgbadger &lt;file_log&gt; &lt;output.html&gt;
</code></pre>

<p>M·∫∑c ƒë·ªãnh pgBadger s·∫Ω ƒë·ªÉ output l√† <code>out.html</code> n·∫øu kh√¥ng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a</p>

<h2 id="report">Report</h2>

<p>Khi m·ªü file <code>output</code> html l√™n s·∫Ω c√≥ r·∫•t nhi·ªÅu th√¥ng tin ph√¢n t√≠ch t·ª´ log file ƒë√≥, m·ªôt s·ªë h√¨nh ·∫£nh:<br />
<img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/kakppqn6wz_liLvC8eKeGH5Yub9IezLL--KQkAFD4qPvC0I3kbq9w3O4xDNbaESBkyMegfqg04ND0j2v7uSm1l144qLz_3Yvt0Iq-_ZMIwlJNqsu6s4bO0F1kR3dMUjedqC16uBUu85.png" alt="alt text" /><br />
<img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/bumajvreio_Screen%20Shot%202017-06-10%20at%204.25.17%20PM.png" alt="alt text" /><br />
<img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/j224q7vafu_Screen%20Shot%202017-06-10%20at%204.25.36%20PM.png" alt="alt text" /><br />
<img src="https://s3-ap-southeast-1.amazonaws.com/kipalog.com/1runvcti4u_Screen%20Shot%202017-06-10%20at%204.30.32%20PM.png" alt="alt text" /></p>

</div>

        <footer class="post-footer clearfix">
    

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Ph%c3%a2n%20t%c3%adch%20slow%20query%20PostgreSQL%20v%e1%bb%9bi%20pgBadger&url=https%3a%2f%2ftrietphm.github.io%2fpost%2fphan-tich-slow-query-postgresql-voi-pgbadger%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftrietphm.github.io%2fpost%2fphan-tich-slow-query-postgresql-voi-pgbadger%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2ftrietphm.github.io%2fpost%2fphan-tich-slow-query-postgresql-voi-pgbadger%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Tea, Coffee &amp; Code" href="https://trietphm.github.io/">Tea, Coffee &amp; Code</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2017 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://trietphm.github.io/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
        <script src="https://trietphm.github.io/js/jquery.fitvids.js"></script>
        <script src="https://trietphm.github.io/js/scripts.js"></script>
    </body>
</html>

